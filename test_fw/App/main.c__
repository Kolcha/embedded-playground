#include <stdio.h>

#include "main.h"

#include "gpio.h"
#include "i2c.h"
#include "spi.h"
#include "usart.h"

#define DECODE_MODE_REG     0x09
#define INTENSITY_REG       0x0A
#define SCAN_LIMIT_REG      0x0B
#define SHUTDOWN_REG        0x0C
#define DISPLAY_TEST_REG    0x0F

void SystemClock_Config(void);

static void write_reg(uint8_t reg, uint8_t value) {
    uint8_t tx_data[2] = { reg, value };
    HAL_GPIO_WritePin(GPIOA, GPIO_PIN_15, GPIO_PIN_RESET);
    HAL_SPI_Transmit(&hspi3, tx_data, 2, 100);
    HAL_GPIO_WritePin(GPIOA, GPIO_PIN_15, GPIO_PIN_SET);
}

static void set_row(uint8_t row_index) {
    write_reg(row_index + 1, 0xFF);
}

static void set_col(uint8_t col_index) {
    for (int i = 0; i < 8; i++) {
        write_reg(i + 1, 0x01 << col_index);
    }
}

static void clear(void) {
    for (int i = 0; i < 8; i++) {
        write_reg(i + 1, 0x00);
    }
}

static void max7219_init() {
    write_reg(DISPLAY_TEST_REG, 0);
    write_reg(SCAN_LIMIT_REG, 7);
    write_reg(DECODE_MODE_REG, 0);
    write_reg(SHUTDOWN_REG, 1);
    clear();
}

int main(void)
{
    HAL_Init();
    SystemClock_Config();
    MX_USART2_UART_Init();
    MX_I2C3_Init();
    MX_GPIO_Init();
    MX_SPI3_Init();
    max7219_init();

    while (1)
    {
        for (int i = 0; i < 8; i++) {
            clear();
            set_row(i);
            printf("set_row(%d)\n", i);
            HAL_Delay(1000);
        }
        for (int i = 0; i < 8; i++) {
            clear();
            set_col(i);
            printf("set_col(%d)\n", i);
            HAL_Delay(1000);
        }
    }
}
